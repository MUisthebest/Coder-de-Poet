# XÓA DÒNG NÀY: version: "3.9"

networks:
  learnix_net:
    driver: bridge

services:
  nginx:
    image: nginx:1.25-alpine
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - frontend
      - auth_service
      - course_service
      - ai_service
      - chat_service
      - ide_service
    networks:
      - learnix_net

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    restart: unless-stopped
    expose:
      - "80"
    networks:
      - learnix_net

  # .NET Auth
  auth_service:
    build:
      context: ./auth_service
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      - ASPNETCORE_URLS=http://0.0.0.0:8080
      - ASPNETCORE_ENVIRONMENT=Production
    env_file: 
      - .env.prod
    expose:
      - "8080"
    networks:
      - learnix_net

  # Kafka services - THÊM VÀO
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    restart: unless-stopped
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - learnix_net

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    restart: unless-stopped
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT://kafka:9092,PLAINTEXT_HOST://144.91.74.84:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks:
      - learnix_net
    healthcheck:
      test: ["CMD", "kafka-topics", "--list", "--bootstrap-server", "localhost:9092"]
      interval: 30s
      timeout: 10s
      retries: 3

  # NestJS Course service - ĐÃ SỬA
  course_service:
    build:
      context: ./course_service
      dockerfile: Dockerfile
    restart: unless-stopped
    env_file:  # ĐÃ SỬA: đúng cú pháp list
      - .env.prod
      - ./course_service/.env
    depends_on:  # ĐÃ SỬA: đúng cú pháp
      kafka:
        condition: service_healthy
    expose:
      - "3001"
    environment:
      - NODE_ENV=production
      - KAFKA_BROKERS=kafka:9092
      - KAFKA_HOST=kafka
      - KAFKA_PORT=9092
    networks:
      - learnix_net

  # Python AI
  ai_service:
    build:
      context: ./AI_service
      dockerfile: Dockerfile
    restart: unless-stopped
    env_file: 
      - .env.prod
    expose:
      - "8000"
    networks:
      - learnix_net

  # Python Chat
  chat_service:
    build:
      context: ./chat_service
      dockerfile: Dockerfile
    restart: unless-stopped
    env_file: 
      - .env.prod
    expose:
      - "8001"
    networks:
      - learnix_net

  # .NET IDE
  ide_service:
    build:
      context: ./ide_service
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      ASPNETCORE_URLS: http://0.0.0.0:8081
      ASPNETCORE_ENVIRONMENT: Production
    env_file: 
      - .env.prod
    expose:
      - "8081"
    networks:
      - learnix_net