
name: learnix

networks:
  learnix_net:
    driver: bridge

services:
  nginx:
    image: nginx:1.25-alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./certbot/www:/var/www/certbot:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
    depends_on:
      - frontend
      - auth_service
      - course_service
      - ai_service
      - chat_service
      - ide_service
    networks:
      - learnix_net

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    restart: unless-stopped
    expose:
      - "80"
    networks:
      - learnix_net

  auth_service:
    build:
      context: ./auth_service
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      ASPNETCORE_URLS: http://0.0.0.0:8080
      ASPNETCORE_ENVIRONMENT: Production
      PORT: "8080"
    env_file:
      - .env.prod
      - ./auth_service/.env
    expose:
      - "8080"
    networks:
      - learnix_net

  # ===== Kafka infra (shared) =====
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    restart: unless-stopped
    environment:
      ZOOKEEPER_CLIENT_PORT: "2181"
      ZOOKEEPER_TICK_TIME: "2000"
    networks:
      - learnix_net

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    restart: unless-stopped
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: "1"
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181

      # Only internal docker network is needed for your microservices
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT

      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: "1"
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: "1"
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: "1"
    networks:
      - learnix_net
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics --bootstrap-server localhost:9092 --list >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 20s

  course_service:
    build:
      context: ./course_service
      dockerfile: Dockerfile
    restart: unless-stopped
    env_file:
      - .env.prod
      - ./course_service/.env
    depends_on:
      kafka:
        condition: service_healthy
    expose:
      - "3000"
    environment:
      NODE_ENV: production
      PORT: "3000"
      KAFKA_BROKERS: kafka:9092
      KAFKA_HOST: kafka
      KAFKA_PORT: "9092"
    networks:
      - learnix_net

  ai_service:
    build:
      context: ./AI_service
      dockerfile: Dockerfile
    restart: unless-stopped
    env_file:
      - .env.prod
    expose:
      - "8000"
    volumes:
      - ./secrets/youtube_cookies.txt:/run/secrets/youtube_cookies.txt:ro
    networks:
      - learnix_net

  chat_service:
    build:
      context: ./chat_service
      dockerfile: Dockerfile
    restart: unless-stopped
    env_file:
      - .env.prod
      - ./chat_service/.env
    expose:
      - "8001"
    networks:
      - learnix_net

  ide_service:
    build:
      context: ./ide_service
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      ASPNETCORE_URLS: http://0.0.0.0:8082
      ASPNETCORE_ENVIRONMENT: Production
      RUNNER_IMAGE: learnix-sandbox-runner:latest
      HOST_SANDBOX_DIR: /tmp
      CONTAINER_SANDBOX_DIR: /tmp
      SANDBOX_TIMEOUT_MS: "2500"
      SANDBOX_CPU: "1.0"
      SANDBOX_MEM: "256m"
      SANDBOX_PIDS: "128"
      MAX_OUTPUT_BYTES: "1048576"

    env_file:
      - .env.prod
    expose:
      - "8082"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp:/tmp
    networks:
      - learnix_net
